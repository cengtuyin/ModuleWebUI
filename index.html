<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>无能的应用</title>
    <link rel="stylesheet" type="text/css" href="./src/css/yinstyle.css">
    <script src="./src/js/yinscript.js" defer></script>
    <script src="./src/js/Shell.js"></script>
    <script src="./src/js/gsap.min.js"></script>
</head>

<body>
    <div class="Header">
        <div class="Header_ContentView">
            <a class="Header_NameView" href="./index.html">
                <img src="./favicon.png" />
                <span>无能的应用</span>
            </a>
            <div class="Header_MoreView">
                <a class="Header_NameView" href="./">
                    <span>More</span>
                </a>
            </div>
        </div>
    </div>
    <div class="Main Main_Tips_Status">
        <div class="Main_Tips Main_Tips_Loading">
            <svg t="1761359571399" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="7511" width="200" height="200">
                <path
                    d="M876.864 782.592c3.264 0 6.272-3.2 6.272-6.656 0-3.456-3.008-6.592-6.272-6.592-3.264 0-6.272 3.2-6.272 6.592 0 3.456 3.008 6.656 6.272 6.656z m-140.544 153.344c2.304 2.432 5.568 3.84 8.768 3.84a12.16 12.16 0 0 0 8.832-3.84 13.76 13.76 0 0 0 0-18.56 12.224 12.224 0 0 0-8.832-3.84 12.16 12.16 0 0 0-8.768 3.84 13.696 13.696 0 0 0 0 18.56zM552.32 1018.24c3.456 3.648 8.32 5.76 13.184 5.76a18.368 18.368 0 0 0 13.184-5.76 20.608 20.608 0 0 0 0-27.968 18.368 18.368 0 0 0-13.184-5.824 18.368 18.368 0 0 0-13.184 5.76 20.608 20.608 0 0 0 0 28.032z m-198.336-5.76c4.608 4.8 11.072 7.68 17.6 7.68a24.448 24.448 0 0 0 17.536-7.68 27.456 27.456 0 0 0 0-37.248 24.448 24.448 0 0 0-17.536-7.68 24.448 24.448 0 0 0-17.6 7.68 27.52 27.52 0 0 0 0 37.184z m-175.68-91.84c5.76 6.08 13.824 9.6 21.952 9.6a30.592 30.592 0 0 0 22.016-9.6 34.368 34.368 0 0 0 0-46.592 30.592 30.592 0 0 0-22.016-9.6 30.592 30.592 0 0 0-21.952 9.6 34.368 34.368 0 0 0 0 46.592z m-121.152-159.36c6.912 7.36 16.64 11.648 26.368 11.648a36.736 36.736 0 0 0 26.432-11.584 41.28 41.28 0 0 0 0-55.936 36.736 36.736 0 0 0-26.432-11.584 36.8 36.8 0 0 0-26.368 11.52 41.28 41.28 0 0 0 0 56zM12.736 564.672a42.88 42.88 0 0 0 30.784 13.44 42.88 42.88 0 0 0 30.784-13.44 48.128 48.128 0 0 0 0-65.216 42.88 42.88 0 0 0-30.72-13.44 42.88 42.88 0 0 0-30.848 13.44 48.128 48.128 0 0 0 0 65.216z m39.808-195.392a48.96 48.96 0 0 0 35.2 15.36 48.96 48.96 0 0 0 35.2-15.36 54.976 54.976 0 0 0 0-74.56 48.96 48.96 0 0 0-35.2-15.424 48.96 48.96 0 0 0-35.2 15.424 54.976 54.976 0 0 0 0 74.56zM168.32 212.48c10.368 11.008 24.96 17.408 39.68 17.408 14.592 0 29.184-6.4 39.552-17.408a61.888 61.888 0 0 0 0-83.84 55.104 55.104 0 0 0-39.616-17.408c-14.656 0-29.248 6.4-39.616 17.408a61.888 61.888 0 0 0 0 83.84zM337.344 124.8c11.52 12.16 27.712 19.264 43.968 19.264 16.256 0 32.448-7.04 43.968-19.264a68.672 68.672 0 0 0 0-93.184 61.248 61.248 0 0 0-43.968-19.264 61.248 61.248 0 0 0-43.968 19.264 68.736 68.736 0 0 0 0 93.184z m189.632-1.088c12.672 13.44 30.528 21.248 48.448 21.248s35.712-7.808 48.384-21.248a75.584 75.584 0 0 0 0-102.464A67.392 67.392 0 0 0 575.36 0c-17.92 0-35.776 7.808-48.448 21.248a75.584 75.584 0 0 0 0 102.464z m173.824 86.592c13.824 14.592 33.28 23.104 52.736 23.104 19.584 0 39.04-8.512 52.8-23.104a82.432 82.432 0 0 0 0-111.744 73.472 73.472 0 0 0-52.8-23.168c-19.52 0-38.912 8.512-52.736 23.168a82.432 82.432 0 0 0 0 111.744z m124.032 158.528c14.976 15.872 36.032 25.088 57.216 25.088 21.12 0 42.24-9.216 57.152-25.088a89.344 89.344 0 0 0 0-121.088 79.616 79.616 0 0 0-57.152-25.088c-21.184 0-42.24 9.216-57.216 25.088a89.344 89.344 0 0 0 0 121.088z m50.432 204.032c16.128 17.088 38.784 27.008 61.632 27.008 22.784 0 45.44-9.92 61.568-27.008a96.256 96.256 0 0 0 0-130.432 85.76 85.76 0 0 0-61.568-27.072c-22.848 0-45.44 9.984-61.632 27.072a96.192 96.192 0 0 0 0 130.432z"
                    fill="#262626" p-id="7512"></path>
            </svg>
            <span>正在加载中</span>
        </div>
    </div>
    <div class="Bottom">
        <a onclick="SwitchPage(0)">
            <svg t="1761358180409" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="6510" width="200" height="200">
                <path
                    d="M417.798203 1016.25308c28.670112 16.894887 51.196629 5.631629 51.196629-28.670112V588.76123c0-34.301741-23.038483-68.603482-51.196629-85.49837L87.579948 297.964379c-28.670112-11.263258-51.196629 0-51.196629 28.670112v398.821738c0 34.301741 23.038483 68.603482 51.196629 85.49837l330.218255 205.298481zM138.776577 172.532639c-28.670112 16.894887-28.670112 39.93337 0 56.828258l325.098592 205.298481c28.670112 16.894887 68.603482 16.894887 96.761628 5.631629L885.73539 274.925896c28.670112-16.894887 28.670112-39.93337 0-56.828258L543.229944 12.799157c-23.038483-16.894887-68.603482-16.894887-96.761629 0L138.776577 172.532639z m421.86022 815.050329c0 34.301741 23.038483 45.565 51.196629 28.670112l325.098592-165.365111c28.670112-16.894887 51.196629-51.196629 51.196629-85.49837v-399.333704c0-34.301741-23.038483-45.565-51.196629-28.670112l-325.098592 165.365111c-28.670112 16.894887-51.196629 51.196629-51.196629 85.49837v399.333704z"
                    fill="#040000" p-id="6511"></path>
            </svg>
            <span>管理</span>
        </a>
        <a onclick="SwitchPage(1)">
            <svg t="1761357903623" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                p-id="5506" width="200" height="200">
                <path
                    d="M512 0C230.4 0 0 227.2 0 512c0 281.6 230.4 512 512 512 284.8 0 512-227.2 512-512S796.8 0 512 0z m0 819.2c-28.8 0-51.2-22.4-51.2-51.2s22.4-51.2 51.2-51.2c28.8 0 51.2 22.4 51.2 51.2 3.2 28.8-22.4 51.2-51.2 51.2z m54.4-220.8c0 28.8-22.4 51.2-51.2 51.2-28.8 0-51.2-22.4-51.2-51.2V256c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2v342.4z"
                    fill="#2D2D2D" p-id="5507"></path>
            </svg>
            <span>日志</span>
        </a>
    </div>
    <script>
        function SwitchPage(page) {
            switch (page) {
                case 0:
                    LoadPage('./web/home.html', page, false, function () {
                        MainView.children[0].children[0].children[1].children[1].innerHTML = "已为您提供了 " + ksu.exec('echo $(( ($(date +%s) - $(stat -c %Y "/data/adb/modules/AutomaticallyDelete_yin/uninstall.sh")) / 86400 ))') + " 天的服务";
                        
                        ksu.exec('cp /data/adb/modules/AutomaticallyDelete_yin/mod.log /data/adb/modules/AutomaticallyDelete_yin/webroot/tmp/mod.log');
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', "./tmp/mod.log", true);
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState === 4 && xhr.status === 200) {
                                const fileDeleteMatches = xhr.responseText.match(/文件删除: (\d+)文件 (\d+)目录 ([\d.]+ [GMK]B)/g) || [];
                                const cacheMatches = xhr.responseText.match(/F2FS-GC缓存清理: ([\d.]+ [GMK]B)/g) || [];
                                const dirtyMatches = xhr.responseText.match(/F2FS-GC脏块清理: ([\d.]+ [GMK]B)/g) || [];
                                let totalFiles = 0;
                                let totalDirs = 0;
                                let totalDeleteSize = 0;
                                let totalCacheSize = 0;
                                let totalDirtySize = 0;
                                fileDeleteMatches.forEach(match => {
                                    const [, files, dirs, size] = match.match(/文件删除: (\d+)文件 (\d+)目录 ([\d.]+ [GMK]B)/);
                                    totalFiles += parseInt(files);
                                    totalDirs += parseInt(dirs);
                                    totalDeleteSize += convertToBytes(size);
                                });
                                cacheMatches.forEach(match => {
                                    const [, size] = match.match(/F2FS-GC缓存清理: ([\d.]+ [GMK]B)/);
                                    totalCacheSize += convertToBytes(size);
                                });
                                dirtyMatches.forEach(match => {
                                    const [, size] = match.match(/F2FS-GC脏块清理: ([\d.]+ [GMK]B)/);
                                    totalDirtySize += convertToBytes(size);
                                });
                                function convertToBytes(sizeStr) {
                                    const [value, unit] = sizeStr.split(' ');
                                    const num = parseFloat(value);
                                    switch (unit) {
                                        case 'GB': return num * 1024 * 1024 * 1024;
                                        case 'MB': return num * 1024 * 1024;
                                        case 'KB': return num * 1024;
                                        default: return num;
                                    }
                                }
                                function formatBytes(bytes) {
                                    if (bytes === 0) return '0 B';
                                    const k = 1024;
                                    const sizes = ['B', 'KB', 'MB', 'GB'];
                                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                                }

                                MainView.children[0].children[1].children[1].innerHTML = `<!-- 规则数量: ??? | 执行次数: ${fileDeleteMatches.length}<br> -->删除量: ${formatBytes(totalDeleteSize)} | 文件: ${totalFiles} 文件夹: ${totalDirs}<br>F2FS-GC 缓存: ${formatBytes(totalCacheSize)} | 脏块: ${formatBytes(totalDirtySize)}`;

                            }
                            // 莫名其妙的有概率会导致重启，故注释
                            // ksu.exec("rm -rf /data/adb/modules/AutomaticallyDelete_yin/webroot/tmp/mod.log");
                        };
                        xhr.send();

                        // 这里还需要检查更新的逻辑，下次一定
                    });

                    break;
                case 1:
                    LoadPage('./web/loading.html', page, true, function () {
                        ksu.exec('cp /data/adb/modules/AutomaticallyDelete_yin/mod.log /data/adb/modules/AutomaticallyDelete_yin/webroot/tmp/mod.log');
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', "./tmp/mod.log", true);
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState === 4 && xhr.status === 200) {
                                MainView.innerHTML = '<div class="Main_Content_List">' + xhr.responseText.replace(/\[(.*)\] 文件删除: (\d+)文件 (\d+)目录 (.*)\n\[.*\] F2FS-GC缓存清理: (.*)\n\[.*\] F2FS-GC脏块清理: (.*)\n/g, '<div class="Main_Content_List_Tips"><h2>$1</h2><p>删除: $4 | 文件: $2  文件夹: $3<br>F2FS-GC 缓存: $5 | 脏块: $6</p></div>') + "</div>";
                                MainView.classList.remove("Main_Tips_Status");
                            }
                            // 莫名其妙的有概率会导致重启，故注释
                            // ksu.exec("rm -rf /data/adb/modules/AutomaticallyDelete_yin/webroot/tmp/mod.log");
                        };
                        xhr.send();
                    });
                    break;
                default:
                    break;
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            try {
                SwitchPage(0);
                ksu.exec('mkdir /data/adb/modules/AutomaticallyDelete_yin/webroot/tmp');
            } catch (error) {
                const Main_TipsView = document.querySelector(".Main_Tips");
                Main_TipsView.classList.remove("Main_Tips_Loading");
                Main_TipsView.children[0].innerHTML = '<path d="M955.7 856l-416-720c-6.2-10.7-16.9-16-27.7-16s-21.6 5.3-27.7 16l-416 720C56 877.4 71.4 904 96 904h832c24.6 0 40-26.6 27.7-48zM480 416c0-4.4 3.6-8 8-8h48c4.4 0 8 3.6 8 8v184c0 4.4-3.6 8-8 8h-48c-4.4 0-8-3.6-8-8V416z m32 352c-26.5 0-48-21.5-48-48s21.5-48 48-48 48 21.5 48 48-21.5 48-48 48z" p-id="8484"></path>';
                Main_TipsView.children[1].innerText = "加载出错";
            }
        });
    </script>
</body>

</html>